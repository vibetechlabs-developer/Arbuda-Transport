{% extends 'masterpage.html' %}

{% block title %}
<title>ARBUDA | Update Inovice </title>
{% endblock %}

{% block content %}
<style>
  mark {
  background: yellow;
  color: black;
  font-weight: bold;
  border-radius: 2px;
}
  </style>

<div class="container-xxl">
  <div class="header d-flex justify-content-between align-items-center mt-2">
    <h4 class="fw-bold py-3 mb-0"><span class="text-muted fw-light"></span>Update Invoice</h4>
  </div>
  <div class="authentication-wrapper authentication-basic container-p-y pt-0">
    <div class="authentication-inner w-100" style="max-width: 100%;">
      <!-- Register Card -->
      <div class="card">
        <div class="card-body">
            <form id="formAuthentication" class="mb-3" method="POST">
              {% csrf_token %}
              <h5 class="text-primary fw-semibold mb-3">Invoice Details</h5>
              <div class="row">
                <div class="mb-3 col-sm-6">
                  <label for="bill_no" class="form-label">Bill no.</label>
                  <select class="form-select ts-select" name="bill_no" id="bill_no"
                    placeholder="Select contract no" autocomplete="off" onchange="fetchInvoice()">
                    <option value="" disabled selected>Select Bill No</option>
                    {% for invoice in allinvoice %}
                    <option value="{{ invoice.id }}">
                      {{ invoice.Bill_no }} -- {{ invoice.contract_id.contract_no }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="mb-3 col-sm-6">
                  <label for="bill_date" class="form-label">Bill Date</label>
                  <input type="date" class="form-control" id="bill_date" name="bill_date" autofocus
                    oninput="this.classList.remove('invalid')" required />
                </div>

              </div>
              <div class="row">
                <div class="mb-3 col-sm-6">
                  <label for="contract_no" class="form-label">Contract No.</label>
                  <input type="text" class="form-control" id="contract_no" name="contract_no" autofocus
                    oninput="this.classList.remove('invalid')" placeholder="Enter contract no" required />
                  <input type="hidden" class="form-control" id="contract_id" name="contract_id" 
                    />
                </div>
                <div class="mb-3 col-sm-6">
                  <label for="rr_number" class="form-label">RR Number</label>
                  <input type="text" class="form-control" id="rr_number" name="rr_number" autofocus
                    oninput="this.classList.remove('invalid')" placeholder="Enter RR number" />
                </div>
              </div>
              <div class="row">
                <!-- <div class="mb-3 col-sm-6">
                  <label for="bill_no" class="form-label">Search</label>
                  <input type="text" class="form-control" id="searchBox" placeholder="Search by Party name,Challan no,destination and Product"
                    oninput="filterTable()" />
                </div> -->
              </div>
              <h5 class="text-primary fw-semibold mb-3">In Invoice</h5>
              <div class="row">
                <div class="table-responsive mb-3">
                  <table id="dispatchTable" class="table table-bordered ">
                    <thead>
                      <tr id="tableHeader" style="word-wrap: none;"></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                  </table>
                </div>
              </div>
              <h5 class="text-primary fw-semibold mb-3">Not In Inovice</h5>
              <div class="row">
                <div class="table-responsive mb-3">
                  <table id="dispatchTable-ninv" class="table table-bordered ">
                    <thead>
                      <tr id="tableHeader-ninv" style="word-wrap: none;"></tr>
                    </thead>
                    <tbody id="tableBody-ninv"></tbody>
                  </table>
                </div>
              </div>
              <div class="col-sm-6">
                <button type="submit" class="btn btn-primary d-grid w-100">Update Bill</button>
              </div>
            </form>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<script>
  document.querySelectorAll('.ts-select').forEach((el) => {
    let settings = {};
    new TomSelect(el, settings);
  });
</script>
<script>
  function fetchSlipDetails() {
    const lr_id = document.getElementById('lr_id').value;
    if (!lr_id) return;

    fetch(`/get-lr-slip-details/?slip-no=${encodeURIComponent(lr_id)}`)
      .then(response => response.json())
      .then(data => {

        if (data.total_freight) {
          document.getElementById('total_freight').value = data.total_freight;
          document.getElementById('total_freight').setAttribute("readonly", true);
          document.getElementById('taxable_amount').value = data.total_freight;
          document.getElementById('taxable_amount').setAttribute("readonly", true);
        } else {
          document.getElementById('total_freight').value = 0;
          document.getElementById('total_freight').setAttribute("readonly", true);
        }
        if (data.laboring) {
          document.getElementById('laboring').value = data.laboring;
          document.getElementById('laboring').setAttribute("readonly", true);
        } else {
          document.getElementById('laboring').value = 0;
          document.getElementById('laboring').setAttribute("readonly", true);
        }
        if (data.advance_payment) {
          document.getElementById('advance_payment').value = data.advance_payment;
          document.getElementById('advance_payment').setAttribute("readonly", true);
        } else {
          document.getElementById('advance_payment').value = 0;
          document.getElementById('advance_payment').setAttribute("readonly", true);
        }

      })
      .catch(err => {
        console.error('Error fetching Slip  details:', err);
      });
  }

  

  // function fetchDispacth() {
  //   const contract_id = document.getElementById('contract_no').value;
  //   if (!contract_id) return;

  //   fetch(`/get-dispacth?contract-id=${encodeURIComponent(contract_id)}`)
  //     .then(response => response.json())
  //     .then(data => {
  //       if (data.destinations) {
  //         document.getElementById("tableHeader").innerHTML = "";
  //         document.getElementById("tableBody").innerHTML = "";

  //         const th1 = document.createElement("th");
  //           th1.textContent = "Select Challan"; // nice labels
  //           document.getElementById("tableHeader").appendChild(th1);

  //         data.fields.forEach(field => {
  //           const th = document.createElement("th");
  //           th.textContent = field.replace(/_/g, " "); // nice labels
  //           document.getElementById("tableHeader").appendChild(th);
  //         });

  //         data.destinations.forEach((dest, index) => {
  //           const tr = document.createElement("tr");
  //           const checkboxTd = document.createElement("td");
  //           const checkbox = document.createElement("input");
  //           checkbox.type = "checkbox";
  //           checkbox.name = "dispatch_ids";
  //           checkbox.value = dest.id; // store dispatch ID
  //           checkbox.classList.add("row-checkbox"); // optional class for styling / JS use
  //           checkboxTd.appendChild(checkbox);
  //           tr.appendChild(checkboxTd);

  //           data.fields.forEach(field => {
  //             const td = document.createElement("td");



  //             if (field === "sr_no") {
  //               td.textContent = index + 1;
  //             } else if (field === "depature_date") {
  //               td.textContent = dest.dep_date || "";
  //             }
  //             else if (field === "dc_field") {
  //               td.textContent = dest.challan_no || "";
  //             }
  //             else if (field === "luggage") {
  //               td.textContent = dest.totalfreight || "";
  //             }
  //             else if (field === "product") {
  //               td.textContent = dest.product_name || "";
  //             }
  //             else if (field === "amount") {
  //               td.textContent = parseInt(dest.totalfreight) + parseInt(dest.unloading_charge);
  //             }

  //             else {
  //               td.textContent = dest[field] || "";
  //             }

  //             tr.appendChild(td);
  //           });

  //           document.getElementById("tableBody").appendChild(tr);
  //         });
  //       }
  //       else {
  //       }


  //     })
  //     .catch(err => {
  //       console.error('Error fetching Slip  details:', err);
  //     });
  // }
  let allDispatches = []; // store fetched data globally
  let allfield 

  function getBillNoValue() {
    const billSelect = document.getElementById("bill_no");
    if (billSelect.tomselect) {
      return billSelect.tomselect.getValue();
    }
    return billSelect.value;
  }

  function fetchInvoice() {
    const bill_no = getBillNoValue();
    if (!bill_no) {
      // Clear tables if no bill_no selected
      document.getElementById("tableHeader").innerHTML = "";
      document.getElementById("tableBody").innerHTML = "";
      document.getElementById("tableHeader-ninv").innerHTML = "";
      document.getElementById("tableBody-ninv").innerHTML = "";
      return;
    }

    fetch(`/api/get-invoice?bill-id=${encodeURIComponent(bill_no)}`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          console.error('API Error:', data.error);
          return;
        }
        if (data.destinations !== undefined) {
          document.getElementById("bill_date").value = data.bill_date || '';
          document.getElementById("contract_no").value = data.contract_no || '';
          document.getElementById("contract_id").value = data.contract_id || '';
          document.getElementById("rr_number").value = data.rr_number || '';
          document.getElementById("bill_date").setAttribute("readonly", true);
          document.getElementById("contract_no").setAttribute("readonly", true);
          allDispatches = data.destinations || [];
          allfield = data.fields || [];
          
          renderTable(allDispatches, allfield); // render initially
        }
        // Always call fetchDispacth after fetching invoice
        fetchDispacth();
      })
      .catch(err => {
        console.error('Error fetching invoice details:', err);
      });
  }
  // function filterTable() {
  //   const search = document.getElementById("searchBox").value.toLowerCase();

  //   const filtered = allDispatches.filter(item =>
  //     (item.challan_no && item.challan_no.toLowerCase().includes(search)) ||
  //     (item.product_name && item.product_name.toLowerCase().includes(search)) ||
  //     (item.destination && item.destination.toLowerCase().includes(search)) ||
  //     (item.unloading_charge && item.unloading_charge.toString().includes(search))
  //   );

  //   // Re-render table with filtered results
    
  //   renderTable(filtered, allfield );
  // }
let currentSearch = "";

function filterTable() {
  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;

  const fromDate = from ? new Date(from) : null;
  const toDate = to ? new Date(to) : null;

  currentSearch = document.getElementById("searchBox").value.toLowerCase();

  const filtered = allDispatches.filter(item => {
    // Text search
    const matchesSearch =
      (item.challan_no && item.challan_no.toLowerCase().includes(currentSearch)) ||
      (item.product_name && item.product_name.toLowerCase().includes(currentSearch)) ||
      (item.destination && item.destination.toLowerCase().includes(currentSearch)) ||
      (item.party_name && item.party_name.toLowerCase().includes(currentSearch));

    // Date filter (assuming your date field is `dep_date` in format "YYYY-MM-DD")
    const itemDate = item.dep_date ? new Date(item.dep_date) : null;
    const matchesDate =
      (!fromDate || (itemDate && itemDate >= fromDate)) &&
      (!toDate || (itemDate && itemDate <= toDate));

    return matchesSearch && matchesDate; // must match both
  });

  renderTable(filtered, allfield);
}
function renderTable(dispatches, fields) {
    const tableHeader = document.getElementById("tableHeader");
    const tableBody = document.getElementById("tableBody");

    tableHeader.innerHTML = "";
    tableBody.innerHTML = "";

    // Header
    const th1 = document.createElement("th");
    th1.textContent = "Select Challan";
    tableHeader.appendChild(th1);

    fields.forEach(field => {
      const th = document.createElement("th");
      th.textContent = field.replace(/_/g, " ");
      th.style.whiteSpace = "nowrap";
      tableHeader.appendChild(th);
    });

    // Action column header
    const actionTh = document.createElement("th");
    actionTh.textContent = "Action";
    actionTh.style.whiteSpace = "nowrap";
    tableHeader.appendChild(actionTh);

    // Rows
    dispatches.forEach((dest, index) => {
      const tr = document.createElement("tr");

      // Checkbox
      const checkboxTd = document.createElement("td");
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.name = "dispatch_ids";
      checkbox.value = dest.id;
      checkbox.setAttribute("checked", true);
      checkbox.classList.add("row-checkbox");
      checkboxTd.appendChild(checkbox);
      tr.appendChild(checkboxTd);

      // Fields
      fields.forEach(field => {
        const td = document.createElement("td");
        if (field === "sr_no") {
          td.textContent = index + 1;
        } else if (field === "depature_date" || field === "dep_date" ) {
          td.style.whiteSpace = "nowrap";
          td.textContent = dest.dep_date || "";
        } else if (field === "dc_field") {
          td.style.whiteSpace = "wrap"
          td.innerHTML = highlightText(dest.challan_no?.toString() || "", currentSearch);
        } else if (field === "luggage") {
          td.textContent = dest.totalfreight || "";
        } else if (field === "product") {
          td.textContent = dest.product_name || "";
        } else if (field === "amount") {
          td.textContent = dest.grand_total;
        } else if (field === "gc_note") {
          td.textContent = dest.gc_note_no;
        } else {
          td.innerHTML = highlightText(dest[field]?.toString() || "", currentSearch);
        }
        tr.appendChild(td);
      });

      // Action column with Edit button
      const actionTd = document.createElement("td");
      actionTd.style.textAlign = "center";
      actionTd.style.whiteSpace = "nowrap";
      const editLink = document.createElement("a");
      editLink.href = `/dispatch-update?dispatch_id=${dest.id}`;
      const editBtn = document.createElement("button");
      editBtn.type = "button";
      editBtn.style.textAlign = "center";
      editBtn.style.padding = "5px 10px";
      editBtn.className = "btn btn-outline-primary";
      editBtn.id = `edit-btn-${dest.id}`;
      const editIcon = document.createElement("i");
      editIcon.className = "bx bx-edit";
      editIcon.style.fontSize = "1rem";
      editBtn.appendChild(editIcon);
      editLink.appendChild(editBtn);
      actionTd.appendChild(editLink);
      tr.appendChild(actionTd);

      // In "In Invoice" table:
      // - While the checkbox is checked, the dispatch remains in this invoice → editing is blocked.
      // - When the checkbox is unchecked, the user intends to remove it from the invoice → allow editing.
      const setEditState = (disabled) => {
        editBtn.disabled = disabled;
        editLink.style.pointerEvents = disabled ? "none" : "auto";
        editLink.style.opacity = disabled ? "0.5" : "1";
        editBtn.style.cursor = disabled ? "not-allowed" : "pointer";
      };

      // Initial state: all rows are part of the invoice, so their checkboxes are checked
      // and editing should be disabled until user unchecks them.
      setEditState(true);

      // Toggle edit availability when user checks/unchecks the row
      checkbox.addEventListener("change", function() {
        if (this.checked) {
          setEditState(true);
        } else {
          setEditState(false);
        }
      });

      tableBody.appendChild(tr);
    });
  }
  function highlightText(text, search) {
  if (!search) return text; // if no search, return plain text
  const regex = new RegExp(`(${search})`, "gi"); // case-insensitive
  return text.replace(regex, `<mark>$1</mark>`);
}

  let allDispatchesninv = []; // store fetched data globally
  let allfieldninv

  function fetchDispacth(contract_id) {
    const bill_id = getBillNoValue();
    if (!bill_id) {
      // Clear the table if no bill_id
      document.getElementById("tableHeader-ninv").innerHTML = "";
      document.getElementById("tableBody-ninv").innerHTML = "";
      return;
    }

    fetch(`/api/get-ninv-dispacth?bill-id=${encodeURIComponent(bill_id)}`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          console.error('API Error:', data.error);
          document.getElementById("tableHeader-ninv").innerHTML = "";
          document.getElementById("tableBody-ninv").innerHTML = "";
          return;
        }
        // Always render table, even if destinations is empty array
        allDispatchesninv = data.destinations || [];
        allfieldninv = data.fields || [];
        renderninvTable(allDispatchesninv, allfieldninv);
      })
      .catch(err => {
        console.error('Error fetching Not In Invoice dispatches:', err);
        document.getElementById("tableHeader-ninv").innerHTML = "";
        document.getElementById("tableBody-ninv").innerHTML = "";
      });
  }

  function renderninvTable(dispatches, fields) {
    const tableHeader = document.getElementById("tableHeader-ninv");
    const tableBody = document.getElementById("tableBody-ninv");

    tableHeader.innerHTML = "";
    tableBody.innerHTML = "";

    // Header
    const th1 = document.createElement("th");
    th1.textContent = "Select Challan";
    tableHeader.appendChild(th1);

    fields.forEach(field => {
      const th = document.createElement("th");
      th.textContent = field.replace(/_/g, " ");
      th.style.whiteSpace = "nowrap";
      tableHeader.appendChild(th);
    });

    // Action column header
    const actionTh = document.createElement("th");
    actionTh.textContent = "Action";
    actionTh.style.whiteSpace = "nowrap";
    tableHeader.appendChild(actionTh);

    // Rows
    dispatches.forEach((dest, index) => {
      const tr = document.createElement("tr");

      // Checkbox
      const checkboxTd = document.createElement("td");
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.name = "dispatch_ids";
      checkbox.value = dest.id;
      checkbox.classList.add("row-checkbox");
      checkboxTd.appendChild(checkbox);
      tr.appendChild(checkboxTd);

      // Fields
      fields.forEach(field => {
        const td = document.createElement("td");
        if (field === "sr_no") {
          td.textContent = index + 1;
        } else if (field === "depature_date" || field === "dep_date" ) {
          td.style.whiteSpace = "nowrap";
          td.textContent = dest.dep_date || "";
        } else if (field === "dc_field") {
          td.style.whiteSpace = "wrap"
          td.innerHTML = highlightText(dest.challan_no?.toString() || "", currentSearch);
        } else if (field === "luggage") {
          td.textContent = dest.totalfreight || "";
        } else if (field === "product") {
          td.textContent = dest.product_name || "";
        } else if (field === "amount") {
          td.textContent = dest.grand_total;
        } else if (field === "gc_note") {
          td.textContent = dest.gc_note_no;
        } else {
          td.innerHTML = highlightText(dest[field]?.toString() || "", currentSearch);
        }
        tr.appendChild(td);
      });

      // Action column with Edit button
      const actionTd = document.createElement("td");
      actionTd.style.textAlign = "center";
      actionTd.style.whiteSpace = "nowrap";
      const editLink = document.createElement("a");
      editLink.href = `/dispatch-update?dispatch_id=${dest.id}`;
      const editBtn = document.createElement("button");
      editBtn.type = "button";
      editBtn.style.textAlign = "center";
      editBtn.style.padding = "5px 10px";
      editBtn.className = "btn btn-outline-primary";
      editBtn.id = `edit-btn-ninv-${dest.id}`;
      const editIcon = document.createElement("i");
      editIcon.className = "bx bx-edit";
      editIcon.style.fontSize = "1rem";
      editBtn.appendChild(editIcon);
      editLink.appendChild(editBtn);
      actionTd.appendChild(editLink);
      tr.appendChild(actionTd);

      // In "Not In Invoice" table, dispatches are already free from invoices,
      // so editing should always be allowed regardless of checkbox state.
      editBtn.disabled = false;
      editLink.style.pointerEvents = "auto";
      editLink.style.opacity = "1";
      editBtn.style.cursor = "pointer";

      tableBody.appendChild(tr);
    });
  }
</script>
<script>
document.getElementById("formAuthentication").addEventListener("submit", function(e){
  const billSelect = document.getElementById("bill_no");
  if (billSelect.tomselect) {
    billSelect.value = billSelect.tomselect.getValue();  // Tom Select
  } else if (billSelect.selectize) {
    billSelect.value = billSelect.selectize.getValue();  // Selectize.js
  }
});
</script>

{% endblock %}