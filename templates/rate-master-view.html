{% extends 'masterpage.html' %}

{% block title %}
<title>ARBUDA | Rate Master </title>
{% endblock %}

{% block content %}

<div class="content-wrapper">
    <!-- Content -->

    <div class="container-xxl grow container-p-y ">
        <div class="header d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold py-3 mb-0"><span class="text-muted fw-light"></span> Rate Master</h4>
            <!-- <button type="button" class="btn btn-primary" style="height: 40px;"><a href="rate-master-form"
                    class="text-white text-decoration-none">Add Rate</a></button> -->
        </div>
        <!-- <div class="filter-tab mb-4 d-flex align-items-center gap-2">
            <h5 class="mb-0 me-2">Filters </h5>
            <button type="button" class="btn btn-primary" style="height: 40px;"><a href="users"
                    class="text-white text-decoration-none">All</a></button>
            <button type="button" class="btn btn-primary" style="height: 40px;"><a href="?filter=admin"
                    class="text-white text-decoration-none">admin</a></button>
            <button type="button" class="btn btn-primary" style="height: 40px;"><a href="?filter=client"
                    class="text-white text-decoration-none">client</a></button>
            <button type="button" class="btn btn-primary" style="height: 40px;"><a href="?filter=distributor"
                    class="text-white text-decoration-none">distributor</a></button>
        </div> -->

        <div class="card" style="overflow: auto; height: 345px;">
            <div class="card-body">
                <div class="row">
                    <div class="mb-3 col-sm-6">
                        <label for="contract_no" class="form-label">Select Contract no.</label>
                        <select class="form-select ts-select" name="contract_no" id="contract_no"
                            placeholder="Select contract no" autocomplete="off" onchange="loadRates()">
                            <option value="" disabled selected>Select contract no</option>
                            {% for contract in allcontract %}
                            <option value="{{ contract.id }}">
                                {{ contract.company_name }} -- {{ contract.contract_no }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="table-responsive text-nowrap">
                        <table class="table table-bordered" id="rateTable">
                            <thead id="rate-table-header">
                                <tr>
                                    <th>Rate Type</th>
                                    <th>From Km</th>
                                    <th>To Km</th>
                                    <th>MT</th>
                                    <th>MT/KM</th>
                                </tr>
                            </thead>
                            <tbody id="rate-table">
                                <!-- Loaded dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
            <!--/ Responsive Table -->
        </div>
        <!-- / Content -->



        <div class="content-backdrop fade"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
    <script>
        document.querySelectorAll('.ts-select').forEach((el) => {

            let settings = {};
            new TomSelect(el, settings);
        });
    </script>
    <script>
        function loadRates() {
            let clientId = document.getElementById("contract_no").value;

            // Check if a contract is selected
            if (!clientId || clientId === "") {
                let tbody = document.getElementById("rate-table");
                let thead = document.getElementById("rate-table-header");
                tbody.innerHTML = "";  // clear old rows
                // Reset to default header
                thead.innerHTML = `
                    <tr>
                        <th>Rate Type</th>
                        <th>From Km</th>
                        <th>To Km</th>
                        <th>MT</th>
                        <th>MT/KM</th>
                    </tr>
                `;
                return;
            }

            fetch(`/api/rates/${clientId}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    let tbody = document.getElementById("rate-table");
                    let thead = document.getElementById("rate-table-header");
                    tbody.innerHTML = "";  // clear old rows

                    if (data.success && data.data && data.data.length > 0) {
                        const rateType = data.rate_type || data.data[0]?.display_type;
                        
                        // Update table header based on rate type
                        if (data.data[0]?.display_type === "taluka") {
                            // Taluka-Wise header
                            thead.innerHTML = `
                                <tr>
                                    <th>Rate Type</th>
                                    <th>District Name</th>
                                    <th>Taluka Name</th>
                                    <th>MT</th>
                                </tr>
                            `;
                        } else if (data.data[0]?.display_type === "district") {
                            // District-Wise header
                            thead.innerHTML = `
                                <tr>
                                    <th>Rate Type</th>
                                    <th>District Name</th>
                                    <th>MT</th>
                                    <th>MT/KM</th>
                                </tr>
                            `;
                        } else {
                            // Kilometer-Wise, Slab-Wise, Incometax-Wise, Cumulative-Wise header
                            thead.innerHTML = `
                                <tr>
                                    <th>Rate Type</th>
                                    <th>From Km</th>
                                    <th>To Km</th>
                                    <th>MT</th>
                                    <th>MT/KM</th>
                                </tr>
                            `;
                        }

                        // Populate table rows based on display type
                        data.data.forEach(rate => {
                            let row = "";
                            
                            if (rate.display_type === "taluka") {
                                // Taluka-Wise row
                                row = `
                                    <tr>
                                        <td>${rate.rate_type || 'N/A'}</td>
                                        <td>${rate.district_name || 'N/A'}</td>
                                        <td>${rate.taluka_name || 'N/A'}</td>
                                        <td>${rate.mt || '0'}</td>
                                    </tr>
                                `;
                            } else if (rate.display_type === "district") {
                                // District-Wise row
                                row = `
                                    <tr>
                                        <td>${rate.rate_type || 'N/A'}</td>
                                        <td>${rate.district_name || 'N/A'}</td>
                                        <td>${rate.mt || '0'}</td>
                                        <td>${rate.mt_per_km || '0'}</td>
                                    </tr>
                                `;
                            } else {
                                // Kilometer-Wise, Slab-Wise, Incometax-Wise, Cumulative-Wise row
                                row = `
                                    <tr>
                                        <td>${rate.rate_type || 'N/A'}</td>
                                        <td>${rate.from_km || 'N/A'}</td>
                                        <td>${rate.to_km || 'N/A'}</td>
                                        <td>${rate.mt || '0'}</td>
                                        <td>${rate.mt_per_km || '0'}</td>
                                    </tr>
                                `;
                            }
                            tbody.innerHTML += row;
                        });
                    } else {
                        // Show message when no rates found
                        // Determine header based on rate_type if available
                        const rateType = data.rate_type;
                        let headerHtml = '';
                        let colspan = 5;
                        
                        if (rateType === "Taluka-Wise") {
                            headerHtml = `
                                <tr>
                                    <th>Rate Type</th>
                                    <th>District Name</th>
                                    <th>Taluka Name</th>
                                    <th>MT</th>
                                </tr>
                            `;
                            colspan = 4;
                        } else if (rateType === "Distric-Wise" || rateType === "District-Wise") {
                            headerHtml = `
                                <tr>
                                    <th>Rate Type</th>
                                    <th>District Name</th>
                                    <th>MT</th>
                                    <th>MT/KM</th>
                                </tr>
                            `;
                            colspan = 4;
                        } else {
                            headerHtml = `
                                <tr>
                                    <th>Rate Type</th>
                                    <th>From Km</th>
                                    <th>To Km</th>
                                    <th>MT</th>
                                    <th>MT/KM</th>
                                </tr>
                            `;
                            colspan = 5;
                        }
                        
                        thead.innerHTML = headerHtml;
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="${colspan}" class="text-center text-muted">No rates found for this contract</td>
                            </tr>
                        `;
                    }
                })
                .catch(err => {
                    console.error("Error fetching rates:", err);
                    let tbody = document.getElementById("rate-table");
                    let thead = document.getElementById("rate-table-header");
                    // Reset to default header on error
                    thead.innerHTML = `
                        <tr>
                            <th>Rate Type</th>
                            <th>From Km</th>
                            <th>To Km</th>
                            <th>MT</th>
                            <th>MT/KM</th>
                        </tr>
                    `;
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-danger">Error loading rates. Please try again.</td>
                        </tr>
                    `;
                });
        }

    </script>
    {% endblock %}